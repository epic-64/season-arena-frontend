<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fight Animation</title>
    <style>
        .battlefield {
            display: flex;
            justify-content: space-between;
            width: 80%;
            margin: 0 auto;
            position: relative;
        }
        .ground-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: black;
        }
        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .actor {
            font-size: 2em;
            transition: transform 0.5s, background-color 0.5s;
        }
        .strike {
            transform: translateX(20px);
        }
        .flicker {
            background-color: white;
        }
        .health-bar-container {
            width: 50px;
            height: 10px;
            background-color: grey;
            margin-top: 5px;
        }
        .health-bar {
            height: 100%;
            background-color: green;
        }
    </style>
</head>
<body>

<body>
<div class="battlefield">
    <div class="ground-line"></div>
    <div id="heroes" class="team"></div>
    <div id="enemies" class="team"></div>
</div>

<script>
    // Function to load JSON log
    async function loadLog() {
        try {
            const response = await fetch('log.json'); // Ensure this path is correct
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error loading log:', error);
        }
    }

    // Function to initialize actors on the battlefield
    function initializeActors(snapshot) {
        const heroesContainer = document.getElementById('heroes');
        const enemiesContainer = document.getElementById('enemies');

        snapshot.actors.forEach(actor => {
            const actorDiv = document.createElement('div');

            // Actor emoji
            if (actor.name === 'EpicHero') actorDiv.textContent = 'ðŸ˜‡';
            else if (actor.name === 'EpicVillain') actorDiv.textContent = 'ðŸ˜ˆ';
            else actorDiv.textContent = 'ðŸ™‚';

            actorDiv.id = `actor-${actor.name}`; // Unique ID for each actor
            actorDiv.classList.add('actor');

            // Health bar container
            const healthBarContainer = document.createElement('div');
            healthBarContainer.classList.add('health-bar-container');

            // Health bar
            const healthBar = document.createElement('div');
            healthBar.classList.add('health-bar');

            // Set initial width based on current hp/maxHp
            healthBar.style.width = `${(actor.hp / actor.maxHp) * 100}%`;

            // Append health bar to container and container to actor div
            healthBarContainer.appendChild(healthBar);

            // Append elements to the actor div
            actorDiv.appendChild(healthBarContainer);

            // Add actors to their respective teams
            if (actor.team === 0) heroesContainer.appendChild(actorDiv);
            else enemiesContainer.appendChild(actorDiv);
        });
    }

    // Function to animate actions from the log
    function animateActions(log) {
        log.forEach((event, index) => {
            setTimeout(() => {

                if (event.type === "playground.engine_v1.CombatEvent.SkillUsed") {

                    const actorElement = document.getElementById(`actor-${event.actor}`);
                    actorElement.classList.add('strike');
                    setTimeout(() => actorElement.classList.remove('strike'), 500);

                } else if (event.type === "playground.engine_v1.CombatEvent.DamageDealt") {

                    const targetElement = document.getElementById(`actor-${event.target}`);
                    targetElement.classList.add('flicker');
                    setTimeout(() => targetElement.classList.remove('flicker'), 500);

                    // Update health bar based on new targetHp value
                    const targetActorHpPercentage = (event.targetHp / event.snapshot.actors.find(a => a.name === event.target).maxHp) * 100;

                    const targetHealthBar = targetElement.querySelector('.health-bar');
                    targetHealthBar.style.width = `${targetActorHpPercentage}%`;
                }

            }, index * 1000); // Delay each action by 1 second

        });
    }

    // Main function to run the animation
    async function runAnimation() {
        const logData = await loadLog();

        // Find initial snapshot from TurnStart event for setup
        const initialSnapshotEvent = logData.find(event => event.type === "playground.engine_v1.CombatEvent.TurnStart");

        if (initialSnapshotEvent && initialSnapshotEvent.snapshot) {
            initializeActors(initialSnapshotEvent.snapshot);
            animateActions(logData);
        } else {
            console.error("Initial snapshot not found in log.");
        }
    }

    // Start animation sequence
    runAnimation();
</script>

</body>
</html>